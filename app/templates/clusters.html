{% extends "base.html" %}

{% block title %}Clusters{% endblock %}
{% block header_title %}Topic Clusters{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <div class="card" style="grid-column: 1 / -1;">
        <h2>Cluster Overview</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Groups of related articles automatically detected
            by AI.</p>
        <div id="clusters-container"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            <div class="loading">Loading clusters...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<div id="detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2 id="modal-title">Details</h2>
        <div id="modal-body">
            <!-- Content injected by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('clusters-container');

        // Modal Elements
        const modal = document.getElementById('detail-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeBtn = document.querySelector('.close-modal');

        // Close Modal Logic
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });

        try {
            const response = await fetch('/api/data');
            const data = await response.json();

            // Group by cluster
            const clusters = {};
            data.forEach(item => {
                const cid = item.topic_cluster;
                if (!clusters[cid]) clusters[cid] = [];
                clusters[cid].push(item);
            });

            container.innerHTML = '';

            Object.keys(clusters).forEach(cid => {
                const items = clusters[cid];
                const card = document.createElement('div');
                card.className = 'card';
                card.style.background = 'var(--bg-card)';
                card.style.cursor = 'pointer'; // Make it look clickable
                card.style.transition = 'var(--transition)';

                // Hover effect
                card.onmouseover = () => card.style.borderColor = 'var(--accent)';
                card.onmouseout = () => card.style.borderColor = 'var(--border)';

                // Find a representative title
                const clusterName = items[0].cluster_name || `Cluster #${cid}`;

                // Logic to find the "best" title or just the first one
                const mainArticle = items[0];

                // Check for event flag
                const isEvent = items.some(i => i.event_flag !== 'Normal');
                const eventBadge = isEvent ? `<span class="tag" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; margin-left: auto;">Event Detected</span>` : '';

                card.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 1.1rem; color: var(--accent);">${clusterName}</h3>
                        ${eventBadge}
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 10px; font-weight: 600;">${mainArticle.Title}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: auto;">
                        <span style="font-size: 0.8rem; color: var(--text-secondary);"><i class="fa-solid fa-layer-group"></i> ${items.length} articles</span>
                        <span style="font-size: 0.8rem; color: var(--accent); opacity: 0.8;">Tap to view <i class="fa-solid fa-arrow-right"></i></span>
                    </div>
                `;

                // Click Handler
                card.addEventListener('click', () => {
                    modalTitle.textContent = clusterName;
                    modalBody.innerHTML = '';

                    // Populate Modal with List
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 1rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;';

                        let badgeColor = '#64748b';
                        if (item.impact_level === 'High Risk') badgeColor = '#ef4444';
                        if (item.impact_level === 'Opportunity') badgeColor = '#22c55e';

                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.8rem; color: var(--text-secondary);">${item.Published || 'Recent'}</span>
                                <span style="font-size: 0.75rem; background: ${badgeColor}20; color: ${badgeColor}; padding: 2px 8px; border-radius: 10px;">${item.impact_level}</span>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 0.5rem; font-size: 1rem;">${item.Title}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 0.5rem;">${item.Summary}</div>
                            <div style="text-align: right;">
                                <a href="${item.Link}" target="_blank" style="color: var(--accent); font-size: 0.85rem; text-decoration: none;">Read Source <i class="fa-solid fa-external-link-alt"></i></a>
                            </div>
                        `;
                        modalBody.appendChild(div);
                    });

                    modal.style.display = 'block';
                });

                container.appendChild(card);
            });

        } catch (error) {
            console.error(error);
            container.innerHTML = '<p>Error loading clusters.</p>';
        }
    });
</script>
{% endblock %}