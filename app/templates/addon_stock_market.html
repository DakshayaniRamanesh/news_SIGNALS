{% extends "base.html" %}

{% block title %}Stock Market Advisor{% endblock %}
{% block header_title %}CSE Investment Signals{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Input Section -->
    <div class="glass-panel" style="margin-bottom: 24px;">
        <h3 style="margin-bottom: 20px;"><i class="fa-solid fa-chart-line"
                style="margin-right: 10px; color: var(--primary);"></i>Investment Parameters</h3>
        <form id="stock-form" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Investment
                    Horizon</label>
                <select id="horizon" class="ios-input"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                    <option value="short">Short Term (Trading)</option>
                    <option value="medium">Medium Term (1-6 Months)</option>
                    <option value="long" selected>Long Term (Investing)</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Risk Appetite</label>
                <select id="risk" class="ios-input"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                    <option value="conservative">Conservative (Low Risk)</option>
                    <option value="moderate" selected>Moderate (Growth)</option>
                    <option value="aggressive">Aggressive (High Return)</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">Focus Sector
                    (Optional)</label>
                <select id="focus_sector" class="ios-input"
                    style="width: 100%; padding: 12px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white;">
                    <option value="all">Analysis All Sectors</option>
                    <option value="Bank">Banking & Finance</option>
                    <option value="Material">Materials & Manufacturing</option>
                    <option value="Food Beve">Food, Beverage & Tobacco</option>
                    <option value="Cap Goods">Capital Goods</option>
                    <option value="Utility">Energy & Utilities</option>
                    <option value="Telecom">Telecommunications</option>
                    <option value="Consumer">Consumer Services</option>
                </select>
            </div>

            <div class="form-actions" style="grid-column: 1 / -1; display: flex; justify-content: flex-end;">
                <button type="submit" class="ios-btn primary" id="btn-analyze">
                    <i class="fa-solid fa-magnifying-glass-chart"></i> Analyze Market
                </button>
            </div>
        </form>
    </div>

    <!-- Loading State -->
    <div id="loader" style="display: none; text-align: center; padding: 40px;">
        <div class="status-pill active" style="display: inline-flex; width: auto;">
            <span class="dot pulse"></span>
            <span>Scanning Market Sentiment & Generating Signals...</span>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results-area" style="display: none;">

        <!-- Summary Cards -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px;">
            <div class="glass-panel" style="text-align: center;">
                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Market Sentiment</h4>
                <div id="market-sentiment" style="font-size: 2rem; font-weight: 700; color: #34c759;">--</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Overall CSE Pulse</div>
            </div>
            <div class="glass-panel" style="text-align: center;">
                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Top Sector</h4>
                <div id="top-sector"
                    style="font-size: 1.5rem; font-weight: 700; color: #007aff; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                    --</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Highest Bullish Signal</div>
            </div>
            <div class="glass-panel" style="text-align: center;">
                <h4 style="color: var(--text-secondary); margin-bottom: 10px;">Recommended Action</h4>
                <div id="rec-action" style="font-size: 2rem; font-weight: 700; color: #ff9500;">--</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Based on Inputs</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">

            <!-- Analysis Column -->
            <div style="display: flex; flex-direction: column; gap: 24px;">
                <!-- AI Strategy -->
                <div class="glass-panel">
                    <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-brain" style="color: var(--primary);"></i> Investment Strategy
                    </h4>
                    <div id="strategy-report" class="markdown-content"
                        style="line-height: 1.6; color: rgba(255,255,255,0.9);"></div>
                </div>

                <!-- Stock Picks -->
                <div class="glass-panel">
                    <h4 style="margin-bottom: 16px;">
                        <i class="fa-solid fa-arrow-trend-up" style="margin-right: 8px;"></i> Stock Watchlist
                    </h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Company /
                                        Ticker</th>
                                    <th style="text-align: center; padding: 12px; color: var(--text-secondary);">
                                        Sentiment</th>
                                    <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Relevant
                                        News Headline</th>
                                    <th style="text-align: center; padding: 12px; color: var(--text-secondary);">Signal
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="stock-list">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Graphs Column -->
            <div style="display: flex; flex-direction: column; gap: 24px;">
                <div class="glass-panel">
                    <h4 style="margin-bottom: 16px;">Sector Performance (Sentiment)</h4>
                    <canvas id="sectorChart" height="250"></canvas>
                </div>
                <!-- Corporate Events -->
                <div class="glass-panel">
                    <h4 style="margin-bottom: 12px; font-size: 0.9rem;">Corporate Events / Earnings</h4>
                    <ul id="corp-events"
                        style="padding-left: 20px; font-size: 0.85rem; color: var(--text-secondary); max-height: 200px; overflow-y: auto;">
                        <li>No recent events detected.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('stock-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = {
            horizon: document.getElementById('horizon').value,
            risk: document.getElementById('risk').value,
            focus_sector: document.getElementById('focus_sector').value
        };

        // Show loader
        document.getElementById('results-area').style.display = 'none';
        document.getElementById('loader').style.display = 'block';

        fetch('/api/addons/analyze-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('results-area').style.display = 'block';

                // Update Summary
                document.getElementById('market-sentiment').innerText = data.market_sentiment_str;
                document.getElementById('market-sentiment').style.color = data.market_sentiment > 0 ? '#34c759' : '#ff3b30';
                document.getElementById('top-sector').innerText = data.top_sector;
                document.getElementById('rec-action').innerText = data.recommended_action;

                // Strategy Report
                let rawReport = data.strategy_report;
                let htmlReport = rawReport.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                document.getElementById('strategy-report').innerHTML = htmlReport;

                // Stock Table
                const tbody = document.getElementById('stock-list');
                tbody.innerHTML = '';
                data.stock_picks.forEach(stock => {
                    let tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid rgba(255,255,255,0.05)';

                    let sentimentColor = stock.sentiment > 0.2 ? '#34c759' : (stock.sentiment < -0.1 ? '#ff3b30' : '#8e8e93');
                    let signalBadge = '';
                    if (stock.signal === 'Buy') signalBadge = '<span style="padding: 2px 8px; background: rgba(52, 199, 89, 0.2); color: #34c759; border-radius: 4px; font-size: 0.75rem;">BUY</span>';
                    else if (stock.signal === 'Sell') signalBadge = '<span style="padding: 2px 8px; background: rgba(255, 59, 48, 0.2); color: #ff3b30; border-radius: 4px; font-size: 0.75rem;">SELL</span>';
                    else signalBadge = '<span style="padding: 2px 8px; background: rgba(142, 142, 147, 0.2); color: #8e8e93; border-radius: 4px; font-size: 0.75rem;">HOLD</span>';

                    tr.innerHTML = `
                <td style="padding: 12px; font-weight: 600;">${stock.name}</td>
                <td style="padding: 12px; text-align: center; color: ${sentimentColor};">${stock.sentiment.toFixed(2)}</td>
                <td style="padding: 12px; font-size: 0.8rem; opacity: 0.8;">${stock.headline}</td>
                <td style="padding: 12px; text-align: center;">${signalBadge}</td>
            `;
                    tbody.appendChild(tr);
                });

                // Events
                const eventList = document.getElementById('corp-events');
                eventList.innerHTML = '';
                if (data.events.length > 0) {
                    data.events.forEach(ev => {
                        let li = document.createElement('li');
                        li.innerHTML = `<strong>${ev.company}</strong>: ${ev.type}`;
                        li.style.marginBottom = '6px';
                        eventList.appendChild(li);
                    });
                } else {
                    eventList.innerHTML = '<li>No significant corporate events found in news.</li>';
                }

                // Sector Chart
                renderSectorChart(data.sector_performance);
            })
            .catch(err => {
                console.error(err);
                alert('Error analyzing stock data.');
                document.getElementById('loader').style.display = 'none';
            });
    });

    let secChart = null;

    function renderSectorChart(data) {
        const ctx = document.getElementById('sectorChart').getContext('2d');
        if (secChart) secChart.destroy();

        // Sort logic handled in backend or here? Backend sends array of {label, value}
        const labels = data.map(d => d.sector);
        const values = data.map(d => d.score);
        const colors = values.map(v => v > 0 ? '#34c759' : '#ff3b30');

        secChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sentiment Score',
                    data: values,
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { grid: { display: false } }
                }
            }
        });
    }
</script>
{% endblock %}